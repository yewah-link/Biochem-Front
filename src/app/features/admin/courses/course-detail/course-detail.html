<!-- VIEW/EDIT MODE ONLY - No create mode anymore -->
@if (course) {
  <div class="max-w-6xl mx-auto p-6 bg-white rounded-lg shadow">
    <div class="flex justify-between items-start pb-6 mb-6 border-b-2 border-gray-200">
      <div class="flex items-center gap-3">
        <h1 class="text-3xl font-bold text-gray-900">{{ course.title }}</h1>
        @if (course.isPublished === true) {
          <span class="px-3 py-1 text-xs font-semibold text-green-700 bg-green-100 rounded-full uppercase">Published</span>
        } @else {
          <span class="px-3 py-1 text-xs font-semibold text-amber-700 bg-amber-100 rounded-full uppercase">Draft</span>
        }
      </div>

      <div class="flex gap-2 flex-wrap">
        @if (!isEditMode) {
          <button
            (click)="toggleEditMode()"
            class="px-4 py-2 bg-gray-600 text-white text-sm rounded-md font-medium hover:bg-gray-700 transition">
            Edit Details
          </button>
        }
        @if (course.isPublished === true) {
          <button
            (click)="unpublishCourse()"
            class="px-4 py-2 bg-yellow-600 text-white text-sm rounded-md font-medium hover:bg-yellow-700 transition">
            Unpublish
          </button>
        } @else {
          <button
            (click)="publishCourse()"
            class="px-4 py-2 bg-amber-700 text-white text-sm rounded-md font-medium hover:bg-amber-800 transition">
            Publish Course
          </button>
        }
        <button
          (click)="deleteCourse()"
          class="px-4 py-2 bg-red-600 text-white text-sm rounded-md font-medium hover:bg-red-700 transition">
          Delete
        </button>
      </div>
    </div>

    <!-- EDIT FORM -->
    @if (isEditMode) {
      <div class="mb-6 p-6 bg-gray-50 rounded-lg">
        <form [formGroup]="courseForm" (ngSubmit)="saveCourse()" class="space-y-6">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Title</label>
            <input
              formControlName="title"
              placeholder="Course Title"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-600 focus:border-amber-600">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Description</label>
            <textarea
              formControlName="description"
              placeholder="Course Description"
              rows="5"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-600 focus:border-amber-600 resize-y"></textarea>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Category</label>
            <select
              formControlName="categoryId"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-600 focus:border-amber-600">
              @for (cat of categories; track cat.id) {
                <option [value]="cat.id">{{ cat.name }}</option>
              }
            </select>
          </div>

          <!-- Thumbnail Upload Section -->
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Course Thumbnail</label>
            
            @if (!thumbnailPreview) {
              <div class="border-2 border-dashed border-gray-300 rounded-md p-6 text-center hover:border-amber-600 transition">
                <input
                  type="file"
                  accept="image/*"
                  (change)="onThumbnailSelected($event)"
                  class="hidden"
                  #thumbnailInput>
                
                <div class="space-y-2">
                  <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <div class="text-sm text-gray-600">
                    <button
                      type="button"
                      (click)="thumbnailInput.click()"
                      class="font-medium text-amber-700 hover:text-amber-800 focus:outline-none">
                      Upload a thumbnail
                    </button>
                    <span class="text-gray-500"> or drag and drop</span>
                  </div>
                  <p class="text-xs text-gray-500">PNG, JPG, GIF up to 5MB</p>
                </div>
              </div>
            } @else {
              <div class="relative">
                <img
                  [src]="thumbnailPreview"
                  alt="Thumbnail preview"
                  class="w-full h-64 object-cover rounded-md border border-gray-300">
                
                <button
                  type="button"
                  (click)="removeThumbnail()"
                  class="absolute top-2 right-2 bg-red-600 text-white p-2 rounded-full hover:bg-red-700 transition shadow-lg">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
                
                @if (selectedThumbnailFile) {
                  <div class="mt-2 text-sm text-gray-600">
                    <span class="font-medium">{{ selectedThumbnailFile.name }}</span>
                    <span class="text-gray-500"> ({{ (selectedThumbnailFile.size / 1024) | number:'1.0-0' }} KB)</span>
                  </div>
                }
              </div>
            }
            
            <p class="mt-2 text-xs text-gray-500">
              @if (isThumbnailChanged) {
                <span class="text-amber-700 font-medium">Thumbnail will be updated when you save changes.</span>
              } @else {
                Current thumbnail is displayed above. Upload a new one to replace it.
              }
            </p>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">Estimated Hours</label>
            <input
              type="number"
              formControlName="estimatedHours"
              min="0"
              step="0.5"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-amber-600 focus:border-amber-600">
          </div>

          <div class="flex gap-3">
            <button
              type="submit"
              [disabled]="!courseForm.valid || isLoading"
              class="px-6 py-2 bg-amber-700 text-white rounded-md font-medium hover:bg-amber-800 disabled:opacity-50 disabled:cursor-not-allowed transition">
              {{ isLoading ? 'Saving...' : 'Save Changes' }}
            </button>
            <button
              type="button"
              (click)="toggleEditMode()"
              [disabled]="isLoading"
              class="px-6 py-2 bg-gray-600 text-white rounded-md font-medium hover:bg-gray-700 disabled:opacity-50 transition">
              Cancel
            </button>
          </div>
        </form>
      </div>
    }

    <!-- COURSE INFO -->
    @if (!isEditMode) {
      <div class="mb-6 p-6 bg-gray-50 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Description</label>
            <p class="text-sm text-gray-900 leading-relaxed">{{ course.description || 'No description provided' }}</p>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Category</label>
            <p class="text-sm text-gray-900">{{ course.category?.name || 'Uncategorized' }}</p>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Estimated Hours</label>
            <p class="text-sm text-gray-900">{{ course.estimatedHours || 0 }} hours</p>
          </div>

          <div>
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Total Content</label>
            <p class="text-sm text-gray-900">
              {{ course.totalVideos || 0 }} videos,
              {{ course.totalNotes || 0 }} notes,
              {{ course.totalExams || 0 }} exams
            </p>
          </div>

          <div class="col-span-1 md:col-span-2">
            <label class="block text-xs font-semibold text-gray-500 uppercase tracking-wide mb-2">Thumbnail</label>
            <img
              [src]="getCourseThumbnailUrl()"
              alt="Course thumbnail"
              class="max-w-sm w-full h-auto rounded-md shadow-sm">
          </div>
        </div>
      </div>
    }

    <!-- CONTENT TABS -->
    <div class="flex gap-2 border-b-2 border-gray-200 mb-6">
      <button
        [class.border-amber-700]="activeTab === 'videos'"
        [class.text-amber-700]="activeTab === 'videos'"
        [class.border-transparent]="activeTab !== 'videos'"
        [class.text-gray-500]="activeTab !== 'videos'"
        (click)="activeTab = 'videos'"
        class="px-6 py-3 text-sm font-medium border-b-2 transition hover:text-amber-700">
        Videos ({{ course.videos?.length || 0 }})
      </button>
      <button
        [class.border-amber-700]="activeTab === 'notes'"
        [class.text-amber-700]="activeTab === 'notes'"
        [class.border-transparent]="activeTab !== 'notes'"
        [class.text-gray-500]="activeTab !== 'notes'"
        (click)="activeTab = 'notes'"
        class="px-6 py-3 text-sm font-medium border-b-2 transition hover:text-amber-700">
        Notes ({{ course.notes?.length || 0 }})
      </button>
      <button
        [class.border-amber-700]="activeTab === 'exams'"
        [class.text-amber-700]="activeTab === 'exams'"
        [class.border-transparent]="activeTab !== 'exams'"
        [class.text-gray-500]="activeTab !== 'exams'"
        (click)="activeTab = 'exams'"
        class="px-6 py-3 text-sm font-medium border-b-2 transition hover:text-amber-700">
        Exams ({{ course.exams?.length || 0 }})
      </button>
    </div>

    <!-- VIDEOS TAB -->
    @if (activeTab === 'videos') {
      <div>
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-900">Course Videos</h3>
          <button
            (click)="addVideo()"
            class="px-4 py-2 bg-amber-700 text-white text-sm rounded-md font-medium hover:bg-amber-800 transition">
            + Add Video
          </button>
        </div>

        @if (course.videos && course.videos.length > 0) {
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-12"></th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-16">#</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Video</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Title</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Duration</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @for (video of course.videos; track video.id; let i = $index) {
                  <tr
                    class="hover:bg-gray-50 transition cursor-move"
                    [class.opacity-50]="draggedVideoIndex === i"
                    [class.border-t-2]="dragOverIndex === i"
                    [class.border-amber-500]="dragOverIndex === i"
                    draggable="true"
                    (dragstart)="onVideoDragStart($event, i)"
                    (dragover)="onVideoDragOver($event, i)"
                    (drop)="onVideoDrop($event, i)"
                    (dragend)="onVideoDragEnd()">
                    <td class="px-6 py-4">
                      <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16" />
                      </svg>
                    </td>
                    <td class="px-6 py-4">
                      <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-amber-100 text-amber-800 text-sm font-semibold">
                        {{ i + 1 }}
                      </span>
                    </td>
                    <td class="px-6 py-4">
                      <img
                        [src]="getVideoThumbnailUrl(video)"
                        [alt]="video.title"
                        class="w-24 h-16 object-cover rounded shadow-sm">
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ video.title }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ video.durationSeconds ? formatDuration(video.durationSeconds) : 'N/A' }}</td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                      <button
                        (click)="editVideo(video.id!)"
                        class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition mr-2">
                        Edit
                      </button>
                      <button
                        (click)="removeVideo(video.id!)"
                        class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                        Remove
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="text-center py-12 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-500">No videos yet. Add your first video!</p>
          </div>
        }
      </div>
    }

    <!-- NOTES TAB -->
    @if (activeTab === 'notes') {
      <div>
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-900">Course Notes</h3>
          <button
            (click)="addNotes()"
            class="px-4 py-2 bg-amber-700 text-white text-sm rounded-md font-medium hover:bg-amber-800 transition">
            + Add Notes
          </button>
        </div>

        @if (course.notes && course.notes.length > 0) {
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider w-16">#</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Title</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider max-w-xs">Preview</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">File</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>

              <tbody class="bg-white divide-y divide-gray-200">
                @for (note of course.notes; track note.id; let i = $index) {
                  <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 text-sm text-gray-900">{{ i + 1 }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 font-medium">{{ note.title }}</td>
                    <td class="px-6 py-4 text-sm text-gray-600 max-w-sm truncate">{{ note.content || 'No content' }}</td>
                    <td class="px-6 py-4 text-sm">
                      @if (note.fileUrl) {
                        <a [href]="note.fileUrl" target="_blank" rel="noopener"
                          class="text-amber-700 font-medium hover:underline">
                          View File
                        </a>
                      } @else {
                        <span class="text-gray-400 italic">None</span>
                      }
                    </td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                      <button (click)="editNote(note.id!)"
                        class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition mr-2">
                        Edit
                      </button>
                      <button (click)="removeNote(note.id!)"
                        class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                        Remove
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="text-center py-12 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-500">No notes yet. Add your first note!</p>
          </div>
        }
      </div>
    }

    <!-- EXAMS TAB -->
    @if (activeTab === 'exams') {
      <div>
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-900">Course Exams</h3>
          <button
            (click)="addExam()"
            class="px-4 py-2 bg-amber-700 text-white text-sm rounded-md font-medium hover:bg-amber-800 transition">
            + Add Exam
          </button>
        </div>

        @if (course.exams && course.exams.length > 0) {
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Title</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Duration</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Passing Score</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Description</th>
                  <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                @for (exam of course.exams; track exam.id) {
                  <tr class="hover:bg-gray-50 transition">
                    <td class="px-6 py-4 text-sm text-gray-900">{{ exam.title }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ exam.duration ? exam.duration + ' min' : 'N/A' }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900">{{ exam.passingScore ? exam.passingScore + '%' : 'N/A' }}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 max-w-md truncate">{{ exam.description || 'No description' }}</td>
                    <td class="px-6 py-4 text-sm whitespace-nowrap">
                      <button
                        (click)="editExam(exam.id!)"
                        class="px-3 py-1 bg-gray-600 text-white text-xs rounded hover:bg-gray-700 transition mr-2">
                        Edit
                      </button>
                      <button
                        (click)="removeExam(exam.id!)"
                        class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition">
                        Remove
                      </button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        } @else {
          <div class="text-center py-12 bg-gray-50 rounded-lg">
            <p class="text-sm text-gray-500">No exams yet. Create your first exam!</p>
          </div>
        }
      </div>
    }
  </div>
}

<!-- LOADING STATE -->
@if (!course && !isLoading) {
  <div class="max-w-4xl mx-auto p-12 text-center">
    <p class="text-gray-500">Course not found.</p>
    <button
      routerLink="/dashboard/courses"
      class="mt-4 px-4 py-2 bg-amber-700 text-white rounded-md hover:bg-amber-800 transition">
      Back to Courses
    </button>
  </div>
}

@if (isLoading) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg">
      <div class="flex items-center space-x-3">
        <svg class="animate-spin h-5 w-5 text-amber-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-gray-700">Processing...</p>
      </div>
    </div>
  </div>
}